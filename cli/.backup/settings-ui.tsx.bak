/**
 * K-Code 설정 UI
 * 모델 관리, API 키 설정, 테스트 등을 위한 인터랙티브 UI
 */

import React, { useState, useEffect } from 'react';
import { Box, Text, useInput, useApp, Newline } from 'ink';
import Spinner from 'ink-spinner';
import { AVAILABLE_MODELS, getApiKey, saveApiKey, type ModelInfo, type Provider } from './models';
import { LLM } from './llm';

interface SettingsUIProps {
  onExit: () => void;
}

type Screen = 'main' | 'test-model' | 'set-api-key' | 'model-list';

interface TestResult {
  modelId: string;
  success: boolean;
  message: string;
  responseTime?: number;
}

export function SettingsUI({ onExit }: SettingsUIProps) {
  const { exit } = useApp();
  const [screen, setScreen] = useState<Screen>('main');
  const [selectedIndex, setSelectedIndex] = useState(0);
  const [testResults, setTestResults] = useState<TestResult[]>([]);
  const [testing, setTesting] = useState(false);
  const [inputMode, setInputMode] = useState<{ provider: Provider; value: string } | null>(null);

  // 메인 메뉴 옵션
  const mainMenuOptions = [
    { key: '1', label: '모델 목록 보기', action: () => setScreen('model-list') },
    { key: '2', label: '모델 테스트하기', action: () => setScreen('test-model') },
    { key: '3', label: 'API 키 설정하기', action: () => setScreen('set-api-key') },
    { key: 'q', label: '종료', action: () => { onExit(); exit(); } },
  ];

  // 키 입력 처리
  useInput((input, key) => {
    // API 키 입력 모드
    if (inputMode) {
      if (key.return) {
        // 입력 완료
        if (inputMode.value.trim()) {
          const success = saveApiKey(inputMode.value.trim(), inputMode.provider);
          if (success) {
            setInputMode(null);
            setScreen('main');
          }
        }
      } else if (key.backspace || key.delete) {
        // 백스페이스
        setInputMode({ ...inputMode, value: inputMode.value.slice(0, -1) });
      } else if (input && !key.ctrl) {
        // 일반 입력
        setInputMode({ ...inputMode, value: inputMode.value + input });
      }
      return;
    }

    // 일반 모드
    if (screen === 'main') {
      const option = mainMenuOptions.find(o => o.key === input);
      if (option) {
        option.action();
      }
    } else if (screen === 'test-model') {
      if (input === 'a') {
        testAllModels();
      } else if (input === 'b' || input === 'q') {
        setScreen('main');
      } else {
        const modelIndex = parseInt(input) - 1;
        if (modelIndex >= 0 && modelIndex < AVAILABLE_MODELS.length) {
          testSingleModel(AVAILABLE_MODELS[modelIndex]);
        }
      }
    } else if (screen === 'model-list') {
      if (input === 'b' || input === 'q') {
        setScreen('main');
      }
    } else if (screen === 'set-api-key') {
      if (input === 'b' || input === 'q') {
        setScreen('main');
      } else {
        // 프로바이더별 API 키 설정
        const providers: Provider[] = ['deepseek', 'openai', 'anthropic', 'minimax', 'qwen', 'google', 'groq'];
        const providerIndex = parseInt(input) - 1;
        if (providerIndex >= 0 && providerIndex < providers.length) {
          setInputMode({ provider: providers[providerIndex], value: '' });
        }
      }
    }
  });

  // 단일 모델 테스트
  async function testSingleModel(model: ModelInfo) {
    setTesting(true);
    const startTime = Date.now();

    try {
      const apiKey = getApiKey(model.provider);
      if (!apiKey) {
        setTestResults(prev => [...prev, {
          modelId: model.id,
          success: false,
          message: `❌ API 키 없음 (${model.provider})`,
        }]);
        setTesting(false);
        return;
      }

      const llm = new LLM({
        model: model.model,
        apiKey,
        baseUrl: model.baseUrl,
        provider: model.provider,
        maxTokens: 100,
      });

      const response = await llm.ask([
        { role: Role.USER, content: '간단히 "안녕하세요"라고만 답해주세요.' }
      ]);

      const responseTime = Date.now() - startTime;

      if (response.content) {
        setTestResults(prev => [...prev, {
          modelId: model.id,
          success: true,
          message: `✓ 성공 (${responseTime}ms)`,
          responseTime,
        }]);
      } else {
        setTestResults(prev => [...prev, {
          modelId: model.id,
          success: false,
          message: '❌ 응답 없음',
        }]);
      }
    } catch (error: any) {
      setTestResults(prev => [...prev, {
        modelId: model.id,
        success: false,
        message: `❌ ${error.message || '오류'}`,
      }]);
    }

    setTesting(false);
  }

  // 모든 모델 테스트
  async function testAllModels() {
    setTesting(true);
    setTestResults([]);

    for (const model of AVAILABLE_MODELS) {
      await testSingleModel(model);
    }

    setTesting(false);
  }

  // 화면 렌더링
  return (
    <Box flexDirection="column" padding={1}>
      {/* 헤더 */}
      <Box borderStyle="double" borderColor="cyan" paddingX={2} paddingY={1} marginBottom={1}>
        <Text bold color="cyan">⚙️  K-Code 설정</Text>
      </Box>

      {/* 메인 메뉴 */}
      {screen === 'main' && (
        <Box flexDirection="column">
          <Text bold color="green">메인 메뉴</Text>
          <Text dimColor>─────────────────────────────────</Text>
          <Newline />
          {mainMenuOptions.map(option => (
            <Box key={option.key} marginBottom={0}>
              <Text color="yellow">[{option.key}]</Text>
              <Text> {option.label}</Text>
            </Box>
          ))}
          <Newline />
          <Text dimColor>숫자 또는 키를 입력하세요</Text>
        </Box>
      )}

      {/* 모델 목록 */}
      {screen === 'model-list' && (
        <Box flexDirection="column">
          <Text bold color="green">사용 가능한 모델</Text>
          <Text dimColor>─────────────────────────────────</Text>
          <Newline />
          {AVAILABLE_MODELS.map((model, idx) => {
            const hasKey = !!getApiKey(model.provider);
            return (
              <Box key={model.id} flexDirection="column" marginBottom={1}>
                <Box>
                  <Text color="cyan" bold>[{idx + 1}]</Text>
                  <Text> {model.name} </Text>
                  <Text dimColor>({model.id})</Text>
                  {hasKey ? (
                    <Text color="green"> ● API 키 설정됨</Text>
                  ) : (
                    <Text color="red"> ○ API 키 필요</Text>
                  )}
                </Box>
                <Box marginLeft={4}>
                  <Text dimColor>{model.description}</Text>
                </Box>
                <Box marginLeft={4}>
                  <Text dimColor>
                    가격: ${model.inputPrice}/${model.outputPrice} per M ·
                    컨텍스트: {(model.contextWindow / 1000).toFixed(0)}K
                  </Text>
                </Box>
              </Box>
            );
          })}
          <Newline />
          <Text dimColor>[b] 뒤로가기 · [q] 종료</Text>
        </Box>
      )}

      {/* 모델 테스트 */}
      {screen === 'test-model' && (
        <Box flexDirection="column">
          <Text bold color="green">모델 테스트</Text>
          <Text dimColor>─────────────────────────────────</Text>
          <Newline />

          {testing && (
            <Box>
              <Text color="yellow">
                <Spinner type="dots" />
              </Text>
              <Text> 테스트 중...</Text>
            </Box>
          )}

          {testResults.length > 0 && (
            <Box flexDirection="column" marginBottom={1}>
              <Text bold>테스트 결과:</Text>
              {testResults.map((result, idx) => (
                <Box key={idx}>
                  <Text color={result.success ? 'green' : 'red'}>
                    {AVAILABLE_MODELS.find(m => m.id === result.modelId)?.name}: {result.message}
                  </Text>
                </Box>
              ))}
            </Box>
          )}

          <Newline />
          <Text>옵션:</Text>
          <Text color="yellow">[a]</Text>
          <Text> 모든 모델 테스트</Text>
          <Newline />
          {AVAILABLE_MODELS.map((model, idx) => (
            <Box key={model.id}>
              <Text color="yellow">[{idx + 1}]</Text>
              <Text> {model.name} 테스트</Text>
            </Box>
          ))}
          <Newline />
          <Text dimColor>[b] 뒤로가기 · [q] 종료</Text>
        </Box>
      )}

      {/* API 키 설정 */}
      {screen === 'set-api-key' && !inputMode && (
        <Box flexDirection="column">
          <Text bold color="green">API 키 설정</Text>
          <Text dimColor>─────────────────────────────────</Text>
          <Newline />

          {(['deepseek', 'openai', 'anthropic', 'minimax', 'qwen', 'google', 'groq'] as Provider[]).map((provider, idx) => {
            const hasKey = !!getApiKey(provider);
            const providerNames: Record<Provider, string> = {
              deepseek: 'DeepSeek',
              openai: 'OpenAI',
              anthropic: 'Anthropic',
              minimax: 'MiniMax',
              qwen: 'Qwen',
              google: 'Google Gemini',
              groq: 'Groq',
            };
            return (
              <Box key={provider}>
                <Text color="yellow">[{idx + 1}]</Text>
                <Text> {providerNames[provider]} </Text>
                {hasKey ? (
                  <Text color="green">● 설정됨</Text>
                ) : (
                  <Text color="red">○ 필요</Text>
                )}
              </Box>
            );
          })}

          <Newline />
          <Text dimColor>숫자를 입력하여 API 키를 설정하세요</Text>
          <Text dimColor>[b] 뒤로가기 · [q] 종료</Text>
        </Box>
      )}

      {/* API 키 입력 모드 */}
      {inputMode && (
        <Box flexDirection="column">
          <Text bold color="green">API 키 입력</Text>
          <Text dimColor>─────────────────────────────────</Text>
          <Newline />
          <Text>
            프로바이더: <Text color="cyan" bold>{inputMode.provider}</Text>
          </Text>
          <Newline />
          <Box>
            <Text>API 키: </Text>
            <Text color="yellow">{inputMode.value || '_'}</Text>
          </Box>
          <Newline />
          <Text dimColor>API 키를 입력하고 Enter를 누르세요</Text>
          <Text dimColor>Backspace로 삭제 가능</Text>
        </Box>
      )}

      {/* 푸터 */}
      <Box marginTop={1} borderStyle="single" borderColor="gray" paddingX={1}>
        <Text dimColor>K-Code v1.0 · OneSaaS Starter</Text>
      </Box>
    </Box>
  );
}
